import{j as i,c as a,b as n,ag as e}from"./chunks/framework.BlzMDYBM.js";const o=JSON.parse('{"title":"How to Install Matrix Synapse Chat on Ubuntu 18.04 LTS","description":"","frontmatter":{},"headers":[],"relativePath":"tools/matrix-synapse.md","filePath":"tools/matrix-synapse.md","lastUpdated":1744879674000}'),t={name:"tools/matrix-synapse.md"};function l(p,s,h,r,k,d){return n(),a("div",null,s[0]||(s[0]=[e(`<h1 id="how-to-install-matrix-synapse-chat-on-ubuntu-18-04-lts" tabindex="-1">How to Install Matrix Synapse Chat on Ubuntu 18.04 LTS <a class="header-anchor" href="#how-to-install-matrix-synapse-chat-on-ubuntu-18-04-lts" aria-label="Permalink to &quot;How to Install Matrix Synapse Chat on Ubuntu 18.04 LTS&quot;">​</a></h1><p>首先必须介绍下Matrix。Matrix是一个开源、可交互、去中心化的实时通信服务框架。使用Matrix可以搭建安全的通信服务器，配合支持 Matrix 的客户端可以实现个人、团队间的实时聊天交互。</p><h2 id="step-0-ubuntu-configure" tabindex="-1">Step 0 - ubuntu configure <a class="header-anchor" href="#step-0-ubuntu-configure" aria-label="Permalink to &quot;Step 0 - ubuntu configure&quot;">​</a></h2><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> apt-get</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> build-essential</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> python3-dev</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> libffi-dev</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">  python-pip</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> python-setuptools</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> sqlite3</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> \\</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">  libssl-dev</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> python-virtualenv</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> libjpeg-dev</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> libxslt1-dev</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="step-1-update-and-upgrade-system" tabindex="-1">Step 1 - Update and Upgrade System <a class="header-anchor" href="#step-1-update-and-upgrade-system" aria-label="Permalink to &quot;Step 1 - Update and Upgrade System&quot;">​</a></h2><p>Login to your Ubuntu server, update the repository and upgrade all packages using the apt command below.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> update</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> upgrade</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>And all ubuntu packages have been upgraded.</p><h2 id="step-2-install-matrix-synapse" tabindex="-1">Step 2 - Install Matrix Synapse <a class="header-anchor" href="#step-2-install-matrix-synapse" aria-label="Permalink to &quot;Step 2 - Install Matrix Synapse&quot;">​</a></h2><p>In this step, we will install the matrix synapse software using the Debian packages from the official matrix repository.</p><p>Add the matrix key and repository by running all commands below.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">wget</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -qO</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> -</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> https://matrix.org/packages/debian/repo-key.asc</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> apt-key</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> add</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> -</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> add-apt-repository</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> https://matrix.org/packages/debian/</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>The command will automatically update the repository.</p><p>Install Matrix Synapse</p><p>Now install matrix synapse using the apt command as below.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> matrix-synapse</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -y</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>During the installation, it will ask you about the matrix server name - type the matrix domain name &#39;matrix.hakase-labs.io&#39;.</p><p>Matrix synapse apt installer - part 1</p><p>And for the anonymous data report, choose &#39;No&#39;.</p><p>Matrix synapse apt installer - part 1</p><p>When the matrix synapse installation is complete, start the service and enable it to launch everytime at system boot.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> matrix-synapse</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> matrix-synapse</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>The matrix synapse is now up and running using the default configuration on port &#39;8008&#39; and &#39;8448&#39;. Check using netstat command.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">netstat</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -plntu</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Check open ports</p><h2 id="step-3-configure-matrix-synapse" tabindex="-1">Step 3 - Configure Matrix Synapse <a class="header-anchor" href="#step-3-configure-matrix-synapse" aria-label="Permalink to &quot;Step 3 - Configure Matrix Synapse&quot;">​</a></h2><p>After the matrix synapse installation, we will configure it to run under the local IP address, disable matrix synapse registration, and enable the registration-shared-secret.</p><p>Before editing the home server configuration, we need to generate the shared secret key.</p><p>Run the command below.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /dev/urandom</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> tr</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -dc</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &#39;a-zA-Z0-9&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> fold</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -w</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 32</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> head</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -n</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 1</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>And you will get the generated key. Copy the result key.</p><p>Now we need to edit the home server configuration file &#39;homeserver.yaml&#39; on the &#39;/etc/matrix-synapse/&#39; directory. Change the current directory to &#39;/etc/matrix-synapse&#39; and edit the configuration file using vim.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /etc/matrix-synapse/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">vim</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> homeserver.yaml</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Change</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> HTTP</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> and</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> HTTPS</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> Listener</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> port</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &#39;8008&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> and</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &#39;8448&#39;</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> to</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> local</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> IP</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> address</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &#39;127.0.0.1&#39;.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    port:</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 8448</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    bind_addresses:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">      -</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &#39;127.0.0.1&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    -</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> port:</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 8008</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    bind_addresses:</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&#39;127.0.0.1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Matrix Synapse configuration</p><p>Matrix Synapse port config</p><p>Disable the matrix synapse registration, uncomment the &#39;registration_shared_secret&#39; configuration and paste the secret key generated.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">enable_registration:</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> False</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">registration_shared_secret:</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;MtkF9JOkNHsRRISyR5L91KAQlrrPhyWX&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Save and exit.</p><p>Note:</p><p>registration_shared_secret: If set allows registration by anyone who also has the shared secret, even if registration is disabled.</p><p>Now restart the matrix synapse services.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> matrix-synapse</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>restart matrix-synapse</p><p>Check the homeserver service using the command below.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">netstat</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -plntu</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>You will get the matrix synapse service is now on the local IP address.</p><p>Check Matrix Synapse Ports</p><p>And we have completed the matrix synapse installation and configuration.</p><h2 id="step-4-generate-ssl-letsencrypt-certificates" tabindex="-1">Step 4 - Generate SSL Letsencrypt Certificates <a class="header-anchor" href="#step-4-generate-ssl-letsencrypt-certificates" aria-label="Permalink to &quot;Step 4 - Generate SSL Letsencrypt Certificates&quot;">​</a></h2><p>In this tutorial, we will enable HTTPS for the Nginx reverse proxy, and we will generate the SSL certificate files from Letsencrypt.</p><p>Install the letsencrypt tool using the apt command below.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> letsencrypt</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -y</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>The Letsencrypt tool is installed on the system, now generate the SSL certificate files for the matrix domain name &#39;matrix.hakase-labs.io&#39; using the certbot command as shown below.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">certbot</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> certonly</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --rsa-key-size</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 2048</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --standalone</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --agree-tos</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --no-eff-email</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --email</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> hakaselabs@gmail.com</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> matrix.hakase-labs.io</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">or</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">certbot</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> certonly</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> matrix.hakase-labs.io</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>The Letsencrypt tool will generate SSL certificate files by running the &#39;standalone&#39; temporary web server for verification.</p><p>And when it&#39;s complete, you will get the result as shown below.</p><p>Generate SSL Letsencrypt Certificates</p><p>SSL certificate files for the matrix synapse domain name &#39;matrix.hakase-labs.io&#39; is generated inside the &#39;/etc/letsencrypt/live/&#39; directory.</p><h2 id="step-5-install-and-configure-nginx-as-a-reverse-proxy" tabindex="-1">Step 5 - Install and Configure Nginx as a Reverse Proxy <a class="header-anchor" href="#step-5-install-and-configure-nginx-as-a-reverse-proxy" aria-label="Permalink to &quot;Step 5 - Install and Configure Nginx as a Reverse Proxy&quot;">​</a></h2><p>In this step, we will install the Nginx web server and configure it as a reverse proxy for home server that is running on the port &#39;8008&#39;.</p><p>Install the Nginx web server using the apt command below.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -y</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>After the installation is complete, start the service and enable it to launch everytime at system boot</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> start</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> nginx</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> enable</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> nginx</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Next, we will create a new virtual host configuration for the matrix domain name &#39;matrix.hakase-labs.io&#39;.</p><p>Go to the &#39;/etc/nginx&#39; configuration directory and create a new virtual host file &#39;matrix&#39;.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> cd</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /etc/nginx/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> sites-available/matrix</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Paste</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> the</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> following</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> configuration</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> there.</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">server</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">       listen</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 80</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">       server_name</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> matrix.hakase-labs.io</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">       return</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 301</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> https://</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">$server_name$request_uri;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">server</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    listen</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 443</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> ssl</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    listen</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> [::]:443 ssl;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    server_name</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> matrix.hakase-labs.io</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    ssl_certificate</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /etc/letsencrypt/live/matrix.hakase-labs.io/fullchain.pem</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    ssl_certificate_key</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /etc/letsencrypt/live/matrix.hakase-labs.io/privkey.pem</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # If you don&#39;t wanna serve a site, comment this out</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    root</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /var/www/html</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    index</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> index.html</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> index.htm</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    location</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /_matrix</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">      proxy_pass</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> http://127.0.0.1:8008</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">      proxy_set_header</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> X-Forwarded-For</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> $remote_addr;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>or</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">server</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    listen</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 80</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">	listen</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> [::]:80;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    server_name</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> matrix.example.com</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 301</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> https://</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">$host$request_uri;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">server</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    listen</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 443</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> ssl</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    listen</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> [::]:443 ssl;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    server_name</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> matrix.example.com</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    ssl</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> on</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    ssl_certificate</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /etc/letsencrypt/live/matrix.example.com/fullchain.pem</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    ssl_certificate_key</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /etc/letsencrypt/live/matrix.example.com/privkey.pem</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    location</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">        proxy_pass</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> http://localhost:8008</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">        proxy_set_header</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> X-Forwarded-For</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> $remote_addr;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">server</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    listen</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 8448</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> ssl</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> default_server</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    listen</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> [::]:8448 ssl default_server;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    server_name</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> matrix.example.com</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    ssl</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> on</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    ssl_certificate</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /etc/letsencrypt/live/matrix.example.com/fullchain.pem</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    ssl_certificate_key</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /etc/letsencrypt/live/matrix.example.com/privkey.pem</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    location</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">        proxy_pass</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> http://localhost:8008</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">        proxy_set_header</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> X-Forwarded-For</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> $remote_addr;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>Save and exit.</p><p>Activate the virtual host file and test the configuration.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">ln</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /etc/nginx/sites-available/matrix</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /etc/nginx/sites-enabled/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -t</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Make sure there is no error, then restart the Nginx services.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> nginx</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Nginx installation and configuration as a reverse proxy for the Matrix Synapse homeserver has been completed.</p><h2 id="step-6-create-a-new-matrix-user" tabindex="-1">Step 6 - Create a New Matrix User <a class="header-anchor" href="#step-6-create-a-new-matrix-user" aria-label="Permalink to &quot;Step 6 - Create a New Matrix User&quot;">​</a></h2><p>At this stage, the matrix synapse homeserver installation and configuration is complete. And in this step, we will show you how to add a new matrix user from the command line server.</p><p>To create a new matrix user, run the command below.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">register_new_matrix_user</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /etc/matrix-synapse/homeserver.yaml</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> https://127.0.0.1:8448</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>Now you need to input the user name, password, and decide whether the user will have the admin privileges or not.</p><p>Below is the result on my system.</p><h2 id="create-homeserver-yaml-config-file" tabindex="-1">create homeserver.yaml config file <a class="header-anchor" href="#create-homeserver-yaml-config-file" aria-label="Permalink to &quot;create homeserver.yaml config file&quot;">​</a></h2><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">python</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> synapse.app.homeserver</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">  --server-name</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> matrix.example.com</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">  --config-path</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> homeserver.yaml</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">  --generate-config</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">  --report-stats=yes</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">|</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">no</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>==============================================================================</p><h2 id="certbot-自动更新-https-证书" tabindex="-1">certbot 自动更新 HTTPS 证书 <a class="header-anchor" href="#certbot-自动更新-https-证书" aria-label="Permalink to &quot;certbot 自动更新 HTTPS 证书&quot;">​</a></h2><p>安装好了 Certbot，给网站安装好了 SSL 证书.</p><h3 id="install-ssl-letsencrypt-certificates" tabindex="-1">Install SSL Letsencrypt Certificates <a class="header-anchor" href="#install-ssl-letsencrypt-certificates" aria-label="Permalink to &quot;Install SSL Letsencrypt Certificates&quot;">​</a></h3><p>安装 letsencrypt 软件</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> apt</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> install</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> letsencrypt</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -y</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>如果启动 nginx 服务, 需要将它关掉, 再去生成新的证书.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> sytemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> stop</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> nginx</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>dms.pub 生成新的证书.</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">certbot</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> certonly</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --rsa-key-size</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 2048</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --standalone</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --agree-tos</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --no-eff-email</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --email</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> admin@dms.pub</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> dms.pub</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">or</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">certbot</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> certonly</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> dms.pub</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>生成新的证书放在 &#39;/etc/letsencrypt/live/&#39; 目录下.</p><h3 id="nginx-配置文件" tabindex="-1">nginx 配置文件 <a class="header-anchor" href="#nginx-配置文件" aria-label="Permalink to &quot;nginx 配置文件&quot;">​</a></h3><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">server</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    listen</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 443</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> ssl</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    listen</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> [::]:443 ssl;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    server_name</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> dms.pub</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    ssl</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> on</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    ssl_certificate</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /etc/letsencrypt/live/dms.pub/fullchain.pem</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    ssl_certificate_key</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /etc/letsencrypt/live/dms.pub/privkey.pem</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">    location</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">        proxy_pass</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> http://localhost:8008</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">        proxy_set_header</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> X-Forwarded-For</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> $remote_addr;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="创建-cron-文件" tabindex="-1">创建 Cron 文件 <a class="header-anchor" href="#创建-cron-文件" aria-label="Permalink to &quot;创建 Cron 文件&quot;">​</a></h3><p>输入以下命令：</p><ol><li>查看crontab定时执行任务列表</li></ol><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">crontab</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -l</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><ol start="2"><li>添加crontab定时执行任务</li></ol><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">crontab</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -e</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="添加编辑-certbot-的自动续期命令" tabindex="-1">添加编辑 Certbot 的自动续期命令 <a class="header-anchor" href="#添加编辑-certbot-的自动续期命令" aria-label="Permalink to &quot;添加编辑 Certbot 的自动续期命令&quot;">​</a></h3><p>在 root cron 文件中，复制以下代码，粘贴，保存，上传。</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 1</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 1</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> *</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> /usr/bin/certbot</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> renew</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --renew-hook</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;/etc/init.d/nginx reload&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>以上含义是：每隔 7 天，夜里 3 点整自动执行检查续期命令一次。续期完成后，重启 nginx 服务。</p><h3 id="重启-cron-服务-使之生效" tabindex="-1">重启 Cron 服务，使之生效 <a class="header-anchor" href="#重启-cron-服务-使之生效" aria-label="Permalink to &quot;重启 Cron 服务，使之生效&quot;">​</a></h3><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">systemctl</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> restart</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> cron.service</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>重启之后，一切搞定！</p><h3 id="想手动尝试-certbot-证书更新" tabindex="-1">想手动尝试 Certbot 证书更新？ <a class="header-anchor" href="#想手动尝试-certbot-证书更新" aria-label="Permalink to &quot;想手动尝试 Certbot 证书更新？&quot;">​</a></h3><p>一般是直接使用 renew 命令，即：</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">/usr/bin/certbot</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> renew</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>但是现在 Certbot 也会自己判断了，没有快到期之前，它也觉得没必要频繁续期。所以看看我们手动去续期的结果：</p>`,114)]))}const g=i(t,[["render",l]]);export{o as __pageData,g as default};
