import{j as i,c as a,b as n,ag as l}from"./chunks/framework.BlzMDYBM.js";const p="/images/golang/1565331217181.png",h="/images/golang/1565488579627.png",t="/images/golang/1565488723410.png",k="/images/golang/1565332723582.png",e="/images/golang/1565529172641.png",r="/images/golang/1565531933966.png",d="/images/golang/1565531989744.png",g="/images/golang/1565532096094.png",E="/images/golang/1542885416102.png",y="/images/golang/1565539693333.png",c="/images/golang/1565542977581.png",u="/images/golang/1542886924797.png",b="/images/golang/clip_image002.jpg",R=JSON.parse('{"title":"租房网","description":"","frontmatter":{"sidebar_position":6},"headers":[],"relativePath":"golang/06.home.md","filePath":"golang/06.home.md","lastUpdated":1744879674000}'),o={name:"golang/06.home.md"};function C(D,s,m,A,F,q){return n(),a("div",null,s[0]||(s[0]=[l('<h1 id="租房网" tabindex="-1">租房网 <a class="header-anchor" href="#租房网" aria-label="Permalink to &quot;租房网&quot;">​</a></h1><h2 id="_1-rest详解" tabindex="-1">1.REST详解 <a class="header-anchor" href="#_1-rest详解" aria-label="Permalink to &quot;1.REST详解&quot;">​</a></h2><p>在进行开发前，这里面需要给大家介绍一个概念，<strong>REST</strong>。</p><p>REST全称是Representational State Transfer，中文意思是表述（编者注：通常译为表征）性状态转移。</p><blockquote><p>也有说全称是 Resource Representational State Transfer 资源表现状态转移</p></blockquote><p>是Roy Thomas Fielding博士于2000年在他的博士论文中提出来的一种万维网软件架构风格，目的是便于不同软件/程序在网络（例如互联网）中互相传递信息。表现层状态转换是根基于超文本传输协议(HTTP)之上而确定的一组约束和属性，是一种设计提供万维网络服务的软件构建风格。符合或兼容于这种架构风格(简称为 REST 或 RESTful)的网络服务，允许客户端发出以统一资源标识符访问和操作网络资源的请求，而与预先定义好的无状态操作集一致化。因此表现层状态转换提供了在互联网络的计算系统之间，彼此资源可交互使用的协作性质(interoperability)。相对于其它种类的网络服务，例如 SOAP服务则是以本身所定义的操作集，来访问网络上的资源。</p><blockquote><p>（摘自维基百科）</p></blockquote><p>概念一般都比较晦涩难懂，我们看一下知乎大神给出的简洁版介绍：</p><p>1.REST不是&quot;rest&quot;这个单词，而是几个单词缩写。但即使那几个单词说出来，也无法理解在说什么 -_-!! （不是要贬低人，是我自己也理解困难）；</p><p>2.REST描述的是在网络中client和server的一种交互形式；REST本身不实用，实用的是如何设计 RESTful API（REST风格的网络接口）；</p><p>3.Server提供的RESTful API中，URL中只使用名词来指定资源，原则上不使用动词。“资源”是REST架构或者说整个网络处理的核心。比如：</p><p>URL全局资源定位符 locat restful</p><p>URI:全局资源标识符 identify</p><p><code>http://api.qc.com/v1/newsfeed</code>: 获取某人的新鲜; <code>http://api.qc.com/v1/friends</code>: 获取某人的好友列表; <code>http://api.qc.com/v1/profile</code>: 获取某人的详细信息;</p><p>4 .用HTTP协议里的动词来实现资源的添加，修改，删除等操作。即通过HTTP动词来实现资源的状态扭转：</p><p><img src="'+p+`" alt="1565331217181"></p><p>比如： DELETE <code>http://api.qc.com/v1/friends</code>: 删除某人的好友 （在http parameter指定好友id） POST <code>http://api.qc.com/v1/</code>friends: 添加好友 UPDATE <code>http://api.qc.com/v1/profile</code>: 更新个人资料</p><p>禁止使用： GET <code>http://api.qc.com/v1/deleteFriend</code></p><p><strong>Restful的好处</strong></p><ul><li><p>轻量，直接基于http，不再需要任何别的诸如消息协议。get/post/put/delete为CRUD操作</p></li><li><p>面向资源，一目了然，具有自解释性。</p></li><li><p>数据描述简单，一般以xml，json做数据交换。</p></li><li><p>无状态，在调用一个接口（访问、操作资源）的时候，可以不用考虑上下文，不用考虑当前状态，极大的降低了复杂度。</p></li><li><p>简单、低耦合</p></li></ul><p>在web开发中，restful是非常常见的设计。在我们接下来的开发过程中，路由尽量使用restful风格。</p><h2 id="_2-ihome开发" tabindex="-1">2.IHome开发 <a class="header-anchor" href="#_2-ihome开发" aria-label="Permalink to &quot;2.IHome开发&quot;">​</a></h2><h3 id="_2-1创建项目" tabindex="-1">2.1创建项目 <a class="header-anchor" href="#_2-1创建项目" aria-label="Permalink to &quot;2.1创建项目&quot;">​</a></h3><p>这里我们使用<code>gin</code>框架作为web框架进行开发，首先我们先来看一下gin的一个简单使用。</p><p>首先是gin的下载，下载命令如下：</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> go</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> get</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -u</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -v</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> github.com/gin-gonic/gin</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>然后我们用简单的示例代码着手gin框架的学习使用，示例代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//初始化路由</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	router </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> gin.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Default</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//路由匹配</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">GET</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;/&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#E36209;">context</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">gin</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		context.Writer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Write</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">([]</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;Hello World&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//开启监听</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Run</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;:8080&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p>非常简单就能实现一个web服务器的雏形，接着我们在项目开发中再详细介绍gin的使用</p><p>开发过程中可能有些内容介绍不够全面，如果想看详细文档可以在下面网址查看：</p><p>github原始地址：<a href="https://github.com/gin-gonic/gin" target="_blank" rel="noreferrer">https://github.com/gin-gonic/gin</a></p><p>github补充示例地址：<a href="https://github.com/gin-gonic/examples/" target="_blank" rel="noreferrer">https://github.com/gin-gonic/examples/</a></p><p>gin中文文档：<a href="https://www.kancloud.cn/shuangdeyu/gin_book/949413" target="_blank" rel="noreferrer">https://www.kancloud.cn/shuangdeyu/gin_book/949413</a></p></blockquote><h3 id="_2-2开发前准备" tabindex="-1">2.2开发前准备 <a class="header-anchor" href="#_2-2开发前准备" aria-label="Permalink to &quot;2.2开发前准备&quot;">​</a></h3><h4 id="_2-2-1创建工具类文件夹" tabindex="-1">2.2.1创建工具类文件夹 <a class="header-anchor" href="#_2-2-1创建工具类文件夹" aria-label="Permalink to &quot;2.2.1创建工具类文件夹&quot;">​</a></h4><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#创建工具函数文件夹</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> utils</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 进入文件夹创建文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> cd</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> utils</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 配置文件读取函数文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> config.go</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 错误码文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> error.go</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>错误码文件error.go内容如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">package</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> utils</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> (</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_OK</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">         =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;0&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_DBERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">      =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4001&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_NODATA</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">     =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4002&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_DATAEXIST</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">  =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4003&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_DATAERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">    =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4004&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_SESSIONERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4101&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_LOGINERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">   =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4102&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_PARAMERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">   =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4103&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_USERONERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">  =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4104&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_ROLEERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">    =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4105&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_PWDERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">     =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4106&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_USERERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">    =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4107&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_SMSERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">     =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4108&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_MOBILEERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">  =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4109&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_REQERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">     =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4201&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_IPERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">      =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4202&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_THIRDERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">   =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4301&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_IOERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">      =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4302&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_SERVERERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">  =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4500&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">	RECODE_UNKNOWERR</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">  =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;4501&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> recodeText </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> map</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_OK:         </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;成功&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_DBERR:      </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;数据库查询错误&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_NODATA:     </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;无数据&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_DATAEXIST:  </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;数据已存在&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_DATAERR:    </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;数据错误&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_SESSIONERR: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;用户未登录&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_LOGINERR:   </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;用户登录失败&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_PARAMERR:   </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;参数错误&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_USERERR:    </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;用户不存在或未激活&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_USERONERR:  </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;用户已经注册&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_ROLEERR:    </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;用户身份错误&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_PWDERR:     </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;密码错误&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_REQERR:     </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;非法请求或请求次数受限&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_IPERR:      </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;IP受限&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_THIRDERR:   </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;第三方系统错误&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_IOERR:      </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;文件读写错误&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_SERVERERR:  </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;内部错误&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_UNKNOWERR:  </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;未知错误&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_SMSERR:     </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;短信失败&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RECODE_MOBILEERR:  </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;手机号错误&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#E36209;">code</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	str, ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> recodeText[code]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> ok {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> str</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> recodeText[RECODE_UNKNOWERR]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><p>配置文件内容，等到我们写业务代码的时候继续补充。</p><h4 id="_2-2-2创建数据库和表" tabindex="-1">2.2.2创建数据库和表 <a class="header-anchor" href="#_2-2-2创建数据库和表" aria-label="Permalink to &quot;2.2.2创建数据库和表&quot;">​</a></h4><p>先创建一个文件夹，用来存放数据库文件：</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> mkdir</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> models</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#创建数据库文件</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> vim</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> models.go</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>数据库文件models.go文件内容如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">package</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> model</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">time</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">	&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">github.com/jinzhu/gorm</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	_ </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">github.com/jinzhu/gorm/dialects/mysql</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 用户 table_name = user */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> User</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	ID            </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                                  //用户编号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Name          </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">        \`gorm:&quot;size:32;unique&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           //用户名</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Password_hash </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">        \`gorm:&quot;size:128&quot; \`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      //用户密码加密的</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Mobile        </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">        \`gorm:&quot;size:11;unique&quot; \`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> //手机号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Real_name     </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">        \`gorm:&quot;size:32&quot; \`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      //真实姓名  实名认证</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Id_card       </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">        \`gorm:&quot;size:20&quot; \`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //身份证号  实名认证</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Avatar_url    </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">        \`gorm:&quot;size:256&quot; \`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //用户头像路径       通过fastdfs进行图片存储</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Houses        []</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">House</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         //用户发布的房屋信息  一个人多套房</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Orders        []</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">OrderHouse</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //用户下的订单       一个人多次订单</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 房屋信息 table_name = house */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> House</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">	gorm</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Model</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                     //房屋编号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	UserId          </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">uint</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           //房屋主人的用户编号  与用户进行关联</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	AreaId          </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">uint</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           //归属地的区域编号   和地区表进行关联</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Title           </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">        \`gorm:&quot;size:64&quot; \`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         //房屋标题</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Address         </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">        \`gorm:&quot;size:512&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         //地址</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Room_count      </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">           \`gorm:&quot;default:1&quot; \`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       //房间数目</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Acreage         </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">           \`gorm:&quot;default:0&quot; json:&quot;acreage&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   //房屋总面积</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">    Price           </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">           \`json:&quot;price&quot;\`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Unit            </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">        \`gorm:&quot;size:32;default:&#39;&#39;&quot; json:&quot;unit&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             //房屋单元,如 几室几厅</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Capacity        </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">           \`gorm:&quot;default:1&quot; json:&quot;capacity&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   //房屋容纳的总人数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Beds            </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">        \`gorm:&quot;size:64;default:&#39;&#39;&quot; json:&quot;beds&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             //房屋床铺的配置</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Deposit         </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">           \`gorm:&quot;default:0&quot; json:&quot;deposit&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   //押金</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Min_days        </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">           \`gorm:&quot;default:1&quot; json:&quot;min_days&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   //最少入住的天数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Max_days        </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">           \`gorm:&quot;default:0&quot; json:&quot;max_days&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   //最多入住的天数 0表示不限制</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Order_count     </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">           \`gorm:&quot;default:0&quot; json:&quot;order_count&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">               //预定完成的该房屋的订单数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Index_image_url </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">        \`gorm:&quot;size:256;default:&#39;&#39;&quot; json:&quot;index_image_url&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> 			 //房屋主图片路径</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Facilities      []</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Facility</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">   \`gorm:&quot;many2many:house_facilities&quot; json:&quot;facilities&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                 //房屋设施   与设施表进行关联</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Images          []</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">HouseImage</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> \`json:&quot;img_urls&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                      //房屋的图片   除主要图片之外的其他图片地址</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Orders          []</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">OrderHouse</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> \`json:&quot;orders&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                        //房屋的订单    与房屋表进行管理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 区域信息 table_name = area */</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  //区域信息是需要我们手动添加到数据库中的</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> Area</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Id     </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">      \`json:&quot;aid&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                        //区域编号     1    2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Name   </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">   \`gorm:&quot;size:32&quot; json:&quot;aname&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       //区域名字     昌平 海淀</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Houses []</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">House</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> \`json:&quot;houses&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> //区域所有的房屋   与房屋表进行关联</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 设施信息 table_name = &quot;facility&quot;*/</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //设施信息 需要我们提前手动添加的</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> Facility</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Id     </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">      \`json:&quot;fid&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     //设施编号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Name   </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">   \`gorm:&quot;size:32&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> //设施名字</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Houses []</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">House</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  //都有哪些房屋有此设施  与房屋表进行关联的</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 房屋图片 table_name = &quot;house_image&quot;*/</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> HouseImage</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Id    </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">    \`json:&quot;house_image_id&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         //图片id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Url   </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> \`gorm:&quot;size:256&quot; json:&quot;url&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //图片url     存放我们房屋的图片</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	HouseId </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">uint</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> \`json:&quot;house_id&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> //图片所属房屋编号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 订单 table_name = order */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> OrderHouse</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">	gorm</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Model</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">               //订单编号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	UserId        </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">uint</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">     \`json:&quot;user_id&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  //下单的用户编号</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //与用户表进行关联</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	HouseId       </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">uint</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">    \`json:&quot;house_id&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> //预定的房间编号</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //与房屋信息进行关联</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Begin_date  </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">time</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Time</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> \`gorm:&quot;type:datetime&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          //预定的起始时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	End_date    </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">time</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Time</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> \`gorm:&quot;type:datetime&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          //预定的结束时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Days        </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       //预定总天数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	House_price </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       //房屋的单价</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Amount      </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       //订单总金额</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Status      </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">    \`gorm:&quot;default:&#39;WAIT_ACCEPT&#39;&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //订单状态</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Comment     </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">    \`gorm:&quot;size:512&quot;\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                //订单评论</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Credit      </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">bool</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		//表示个人征信情况 true表示良好</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> InitDb</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()(</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">gorm</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">DB</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //sql.Open()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	db,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> gorm.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Open</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;mysql&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;root:123456@tcp(127.0.0.1:3306)/test?charset=utf8&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	defer</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Close</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SingularTable</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">AutoMigrate</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">User</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">),</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">House</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">),</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Area</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">),</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Facility</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">),</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">HouseImage</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">),</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">OrderHouse</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">))</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		/*db.DB().SetMaxIdleConns(10)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		db.DB().SetConnMaxLifetime(100)*/</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> db,</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	return</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> ,err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br></div></div><blockquote><p>这里我们使用gorm来创建数据库表</p></blockquote><h4 id="_2-2-3导入前端页面并展示" tabindex="-1">2.2.3导入前端页面并展示 <a class="header-anchor" href="#_2-2-3导入前端页面并展示" aria-label="Permalink to &quot;2.2.3导入前端页面并展示&quot;">​</a></h4><p>把我们的html.zip拷贝过去，然后解压到对应目录。接着我们就可以开发具体业务了。</p><p>然后修改main.go文件，内容如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">package</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> main</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">import</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">github.com/gin-gonic/gin</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//初始化路由</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	router </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> gin.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Default</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//映射静态资源</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Static</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;/home&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;html&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//开启监听</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Run</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;:8080&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><blockquote><p>设置静态路径有三个方法，分别是：</p><p>Static:两个参数，第一个参数是资源路径，第二个参数是指定的文件夹,示例：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Static</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;/assets&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;./assets&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>StaticFS：两个参数，第一个参数是资源路径，第二个参数是http.Dir(),示例代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">StaticFS</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;/more_static&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, http.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Dir</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;my_file_system&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">))</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>StaticFile:俩个参数，第一个参数是资源路径，第二个参数是具体的文件</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span>router.StaticFile(&quot;/favicon.ico&quot;, &quot;./resources/favicon.ico&quot;)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></blockquote><p>运行项目，打开浏览器输入网址<code>127.0.0.1:8080/home</code>，查看页面如下：</p><p><img src="`+h+'" alt="1565488579627"></p><p>按f12打开开发者工具，然后再次刷新页面，结果如下：</p><p><img src="'+t+`" alt="1565488723410"></p><p>这些报红的页面就是需要我们接着来实现的具体功能，让我们先从获取地域信息开始！</p><h3 id="_2-3获取地域信息" tabindex="-1">2.3获取地域信息 <a class="header-anchor" href="#_2-3获取地域信息" aria-label="Permalink to &quot;2.3获取地域信息&quot;">​</a></h3><h4 id="_2-3-1接口定义如下" tabindex="-1"><strong>2.3.1接口定义如下</strong> <a class="header-anchor" href="#_2-3-1接口定义如下" aria-label="Permalink to &quot;**2.3.1接口定义如下**&quot;">​</a></h4><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#Request:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">method: GET</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">url:api/v</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">/areas</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#data:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">no input data</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#Response</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#返回成功：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">    &quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">    &quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;OK&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">    &quot;data&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">    {</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">&quot;aid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">&quot;aname&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;东城区&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">    {</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">&quot;aid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">&quot;aname&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;西城区&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">    {</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">&quot;aid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">&quot;aname&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;通州区&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">    {</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">&quot;aid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">&quot;aname&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;顺义区&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}] </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#注册失败：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">    &quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;400x&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//状态码</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">    &quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;状态错误信息&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="_2-3-2业务流程图" tabindex="-1"><strong>2.3.2业务流程图</strong> <a class="header-anchor" href="#_2-3-2业务流程图" aria-label="Permalink to &quot;**2.3.2业务流程图**&quot;">​</a></h4><p><img src="`+k+`" alt="1565332723582"></p><h4 id="_2-3-3添加对应路由和业务处理" tabindex="-1">2.3.3添加对应路由和业务处理 <a class="header-anchor" href="#_2-3-3添加对应路由和业务处理" aria-label="Permalink to &quot;2.3.3添加对应路由和业务处理&quot;">​</a></h4><p>在<code>main.go</code>页面进行修改，添加对应路由和处理函数，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//初始化路由</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	router </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> gin.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Default</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//映射静态资源</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Static</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;/home&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;html&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//添加动态路由</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	r1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Group</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;api/v1.0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		r1.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">GET</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;/areas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,controller.GetArea)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//开启监听</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Run</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;:8080&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><blockquote><p>在使用gin开发时，一般情况会按照模块把路由分为不同的组，然后在组内再做路由匹配。</p><p>使用路由匹配对应函数，函数格式必须是func(*gin.Context)</p></blockquote><p>接着我们来实现对应的控制器方法，方法名需要参考开发文档，和开发文档保持一直。</p><h4 id="_2-3-4具体业务实现" tabindex="-1">2.3.4具体业务实现 <a class="header-anchor" href="#_2-3-4具体业务实现" aria-label="Permalink to &quot;2.3.4具体业务实现&quot;">​</a></h4><p>这里我们把获取地域信息业务放到服务中实现，然后用远程调用。首先我们来创建一个服务：</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> micro</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --type</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> srv</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> protect/getArea</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>然后去修改proto文件并编译自动生成的proto文件：</p><p>修改后的proto文件如下：</p><div class="language-protobuf vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">protobuf</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">syntax</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;proto3&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">package</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> go.micro.srv.getArea</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">service</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> GetArea</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	rpc</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> Call</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">returns</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Response</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">message</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> Request</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">message</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	repeated</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> area</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> data </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">message</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> area</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	int32</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> aid </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> aname </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><blockquote><p>根据接口文档定义的传入数据和传出数据定义protobuf格式，然后编译proto文件</p></blockquote><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> make</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> proto</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>然后删除掉main.go中的无用代码。进handler.go中进行代码实现。</p><p><strong>业务分析</strong></p><p>从业务流程图可知，我们需要从redis中获取数据，获取到数据就把数据通过json打包，传回给前端，获取不到数据，就从mysql中拿数据，拿到数据之后再把用json序列化之后存到redis中，然后把数据返回给前端。</p><p>那我们首先从redis中获取数据,这里我们直接用redis连接池来实现。其实在我们调用的redis包中有redis连接池的接口，我们直接使用即可，redis连接池代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> RedisClient </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">redis</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Pool</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> InitRedis</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	RedisClient </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">redis</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Pool</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //设置redis连接池最大空闲链接数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		MaxIdle:utils.G_redis_maxidel,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //设置redis连接池最大同时链接数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		MaxActive:utils.G_redis_maxactive,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        //设置redis连接池最大空闲时间</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		IdleTimeout:utils.G_redis_idletimeout,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		//连接redis</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		Dial: </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">() (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">redis</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Conn</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			conn,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Dial</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;tcp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,utils.G_redis_addr</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">utils.G_redis_port)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">				return</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            //设置选中哪个数据库</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			conn.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Do</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;select&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,utils.G_redis_db)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> conn,</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>从redis中获取数据，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//连接redis</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	redisPool</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">model.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">InitRedis</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	client </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> redisPool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	defer</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Close</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	areaResp,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Do</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;get&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;areas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">))</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>校验是否能够获取到数据，如果获取不到，从mysql中获取代码，然后存储到redis中，具体代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	var</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> areas []</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">model</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Area</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> len</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(areaResp) </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		//第一次从mysql中获取数据 调用封装的函数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		areas,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> model.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">GetAllArea</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DBERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DBERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		//对areas数据编码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		areaBytes ,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> json.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Marshal</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(areas)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		//存储到redis中</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		_,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Do</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;set&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;areas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,areaBytes))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> json.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Unmarshal</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(areaResp,</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">areas)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>这里我们把mysql操作封装成函数，放到model包中。具体实现如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> GetAllArea</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">db</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">gorm</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">DB</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)([]</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Area</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">){</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	var</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> areas []</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Area</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Find</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">areas).Error</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> areas,</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>gorm获取数据方法非常多，常见的方法如下：</p><p>获取一条数据：db.First(),db.Last()</p><p>获取所有数据：db.Find()</p><p>指定查询条件：db.Where(&quot;name=?&quot;,&quot;xiaohong&quot;).Find()或者db.Find(user,&quot;name = ?&quot;,&quot;xiaohong&quot;)</p><p>获取部分字段数据：db.Table(&quot;user&quot;).select(&quot;name&quot;,&quot;age&quot;).where(&quot;name=?&quot;,&quot;xiaohong&quot;).Scan(自定义结构体)</p></blockquote><p>完整代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//初始化返回值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_OK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	resp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_OK)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//连接redis</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	redisPool</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">model.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">InitRedis</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	client </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> redisPool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	defer</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Close</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	areaResp,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Bytes</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Do</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;get&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;areas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	var</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> areas []</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">model</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Area</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> len</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(areaResp) </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		//第一次从mysql中获取数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		db,_ </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">model.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">InitDb</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		areas,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> model.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">GetAllArea</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(db)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DBERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DBERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		//对areas数据编码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		areaBytes ,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> json.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Marshal</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(areas)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		//存储到redis中</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		_,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Do</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;set&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;areas&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,areaBytes))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> json.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Unmarshal</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(areaResp,</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">areas)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			resp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">			return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	for</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> _,v </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> areas{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		temp </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> getArea</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Area</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			Aid:</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">int32</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(v.Id),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			Aname:v.Name,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp.Data </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> append</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(resp.Data,</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">temp)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	return</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><h4 id="_2-3-5web端回调服务接口" tabindex="-1">2.3.5web端回调服务接口 <a class="header-anchor" href="#_2-3-5web端回调服务接口" aria-label="Permalink to &quot;2.3.5web端回调服务接口&quot;">​</a></h4><p>现在服务接口写完了，我们可以在web端调用一下这个接口，调用的方法和我们以前用go-micro方法一样，具体代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> GetArea</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#E36209;">ctx</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">gin</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//初始化service</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	reg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> consul.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewRegistry</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#E36209;">options</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">registry</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Options</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		options.Addrs </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> []</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;127.0.0.1:8500&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	service </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> grpc.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewService</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		micro.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Registry</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(reg),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//获取操作客户端</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	grpcClient </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> getArea.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewGetAreaService</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;go.micro.srv.getArea&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,service.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Client</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">())</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//回调函数</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	resp ,err</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> grpcClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Call</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">TODO</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(),</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">getArea</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,resp)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>开启web服务和获取地域信息服务，然后再打开我们页面，点击选择城区，显示如下：</p><p><img src="`+e+`" alt="1565529172641"></p><blockquote><p>地域信息就获取到了</p></blockquote><h3 id="_2-4获取验证码业务实现" tabindex="-1">2.4获取验证码业务实现 <a class="header-anchor" href="#_2-4获取验证码业务实现" aria-label="Permalink to &quot;2.4获取验证码业务实现&quot;">​</a></h3><p>要显示注册页面，需要先把注册按钮显示出来，这里我们需要先给session请求回个假数据，然后再去实现注册相关业务。</p><h4 id="_2-4-1模拟回复session请求" tabindex="-1">2.4.1模拟回复session请求 <a class="header-anchor" href="#_2-4-1模拟回复session请求" aria-label="Permalink to &quot;2.4.1模拟回复session请求&quot;">​</a></h4><p>根据开发文档我们知道session的请求是<code>api/v1.0/session</code>,失败的话返回数据为，errno和errmsg。</p><p>我们先在web端给对应路由做匹配，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">r1.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">GET</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;/session&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,controller.GetSession)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>然后在控制器中实现GetSession函数，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//获取session信息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> GetSession</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">ctx</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">gin</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	resp </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> make</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//初始化返回值</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_SESSIONERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_SESSIONERR)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//返回数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,resp)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这时候再刷新页面，显示如下：</p><p><img src="`+r+'" alt="1565531933966"></p><p>接着我们点击注册按钮，显示注册页面，页面如下：</p><p><img src="'+d+'" alt="1565531989744"></p><h4 id="_2-4-2获取验证码图片" tabindex="-1">2.4.2获取验证码图片 <a class="header-anchor" href="#_2-4-2获取验证码图片" aria-label="Permalink to &quot;2.4.2获取验证码图片&quot;">​</a></h4><p>进入注册页面之后，在开发者工具中，会发现下面的问题：</p><p><img src="'+g+`" alt="1565532096094"></p><p>验证码请求未实现，接着我们就来实现验证码服务。首先是创建服务，命令如下：</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> micro</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --type</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> srv</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> project/getImageCode</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>然后根据开发文档规定的请求参数和返回值修改proto文件并编译，修改之后的proto文件如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">syntax </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;proto3&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">package</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> go</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.micro.srv.getImageCode;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">service GetImageCode {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	rpc </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Call</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(Request) returns (Response) {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">message Request {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> uuid </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">message Response {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="_2-4-3业务流程图" tabindex="-1">2.4.3业务流程图 <a class="header-anchor" href="#_2-4-3业务流程图" aria-label="Permalink to &quot;2.4.3业务流程图&quot;">​</a></h4><p><img src="`+E+`" alt=""></p><h4 id="_2-4-4具体业务实现" tabindex="-1">2.4.4具体业务实现 <a class="header-anchor" href="#_2-4-4具体业务实现" aria-label="Permalink to &quot;2.4.4具体业务实现&quot;">​</a></h4><p>根据流程图分析可知，我们需要生成验证码图片，然后把验证码图片中的随机数和传入的uuid一起存到redis中。那我们先来看看图片验证码如何生成。我们这里选择的是<code>github.com/afocus/captcha</code>来实现验证码功能。</p><p>要使用这个包首先当然是去下载这个包，下载命令如下：</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> go</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> get</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -u</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -v</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> github.com/afocus/captcha</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>然后我们来看一下这个包的一个简单示例代码，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">cap </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> captcha.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">New</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 可以设置多个字体 或使用cap.AddFont(&quot;xx.ttf&quot;)追加</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetFont</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;comic.ttf&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;xxx.ttf&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 设置验证码大小</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetSize</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 设置干扰强度</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetDisturbance</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(captcha.MEDIUM)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 设置前景色 可以多个 随机替换文字颜色 默认黑色</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetFrontColor</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">color</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RGBA</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">})</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 设置背景色 可以多个 随机替换背景色 默认白色</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetBkgColor</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">color</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RGBA</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">color</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RGBA</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">color</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RGBA</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">153</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//设置验证码个数，以及格式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">img,str </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Create</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,captcha.NUM)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>我们可以先来跑一下这个包给我们提供的示例代码，代码路径为：代码路径在<code>github.com/afocus/captcha/examples/main.go</code>,具体代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	cap </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> captcha.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">New</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetFont</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;comic.ttf&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">); err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">		panic</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(err.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Error</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	/*</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	   //We can load font not only from localfile, but also from any []byte slice</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	   	fontContenrs, err := ioutil.ReadFile(&quot;comic.ttf&quot;)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	   	if err != nil {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	   		panic(err.Error())</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	   	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	   	err = cap.AddFontFromBytes(fontContenrs)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	   	if err != nil {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	   		panic(err.Error())</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	   	}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	*/</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetSize</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetDisturbance</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(captcha.MEDIUM)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetFrontColor</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">color</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RGBA</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">})</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetBkgColor</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">color</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RGBA</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">color</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RGBA</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">color</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RGBA</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">153</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	http.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">HandleFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;/r&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#E36209;">w</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> http</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">ResponseWriter</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#E36209;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		img, str </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Create</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, captcha.ALL)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		png.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Encode</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(w, img)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">		println</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(str)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	http.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">HandleFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;/c&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#E36209;">w</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> http</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">ResponseWriter</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#E36209;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		str </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> r.URL.RawQuery</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		img </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">CreateCustom</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(str)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		png.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Encode</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(w, img)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	http.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">ListenAndServe</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;:8086&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><blockquote><p>代码中共有两种生成图片的方式，一种是生成带验证码的图片，并返回验证码，一种是指定验证码内容，生成图片。</p></blockquote><p>运行这个代码， 在浏览器中访问，显示如下：</p><p><img src="`+y+`" alt="1565539693333"></p><p>根据示例代码，来实现我们的生成验证码服务。具体实现如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//获取验证码操作对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	cap </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> captcha.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">New</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//设置字体库</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetFont</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;comic.ttf&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">); err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">		panic</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(err.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Error</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//设置验证码属性</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetSize</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">128</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetDisturbance</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(captcha.MEDIUM)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetFrontColor</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">color</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RGBA</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">})</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">SetBkgColor</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">color</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RGBA</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">color</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RGBA</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">color</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RGBA</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">153</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">255</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//生成图片</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	img, str </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> cap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Create</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, captcha.ALL)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//获取到验证码,把验证码结合uuid写入redis中</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	redisPool </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> model.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">InitRedis</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	redisConn </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> redisPool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	redisConn.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Do</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;setex&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,req.Uuid,</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">60</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,str)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//把拿到的图片对象序列化成字节切片传递给web</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	imgBuffer,_</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">json.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Marshal</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(img)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	rsp.Msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> imgBuffer</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="_2-4-5web端接收数据并传递给浏览器" tabindex="-1">2.4.5web端接收数据并传递给浏览器 <a class="header-anchor" href="#_2-4-5web端接收数据并传递给浏览器" aria-label="Permalink to &quot;2.4.5web端接收数据并传递给浏览器&quot;">​</a></h4><p>首先我们现在web端对路由做一个匹配，然后指定操作函数，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">r1.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">GET</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;/imagecode/:uuid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,controller.GetImageCode)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>然后我们来实现GetImageCode函数。首先我们需要获取请求传过来的数据，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//获取数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">uuid </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Param</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;uuid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>gin获取前端传递的数据有不同的方法，具体如下：</p><p>获取路径中的参数为：ctx.Param(&quot;name&quot;)</p><p>获取get请求传递的数据，方法为：ctx.Query(&quot;lastname&quot;) ,ctx.DefaultQuery(&quot;firstname&quot;, &quot;Guest&quot;)</p><p>获取post请求传递的数据，方法为：ctx.PostForm(&quot;message&quot;),c.DefaultPostForm(&quot;nick&quot;, &quot;anonymous&quot;)</p><p>需要注意的是post这种获取方法必须是form data传递的才能获取到，如果传递的数据是json的话，我们就需要创建一个对应的结构体，给数据进行绑定，具体操作为：ctx.Bind()或者ctx.BindJSON()</p></blockquote><p>然后我们调用服务，把uuid传递给服务，并接收数据,代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//链接服务并调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	service </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">GetGrpcService</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	grpcClent </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> getImageCode.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewGetImageCodeService</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;go.micro.srv.getImageCode&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,service.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Client</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	resp,err</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">grpcClent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Call</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">TODO</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(),</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">getImageCode</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		Uuid:uuid,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,resp)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><blockquote><p>这里我们把连接服务的代码封装成一个函数，直接使用即可。</p></blockquote><p>得到数据之后对数据进行解析，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//解析返回数据为image,传回前端</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	var</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> img </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">captcha</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Image</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	json.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Unmarshal</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(resp.Msg,</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">img)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	png.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Encode</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(ctx.Writer,img)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>全部代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//获取验证码图片</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> GetImageCode</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">ctx</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">gin</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">){</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//获取数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	uuid </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Param</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;uuid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//链接服务并调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	service </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">GetGrpcService</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	grpcClent </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> getImageCode.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewGetImageCodeService</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;go.micro.srv.getImageCode&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,service.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Client</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	resp,err</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">grpcClent.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Call</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">TODO</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(),</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">getImageCode</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		Uuid:uuid,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,resp)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//解析返回数据为image,传回前端</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	var</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> img </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">captcha</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Image</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	json.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Unmarshal</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(resp.Msg,</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">img)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	png.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Encode</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(ctx.Writer,img)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>这时候重启项目，访问注册线面，显示如下：</p><p><img src="`+c+`" alt="1565542977581"></p><h3 id="_2-5获取短信验证码" tabindex="-1">2.5获取短信验证码 <a class="header-anchor" href="#_2-5获取短信验证码" aria-label="Permalink to &quot;2.5获取短信验证码&quot;">​</a></h3><h4 id="_2-5-1接口定义" tabindex="-1">2.5.1接口定义 <a class="header-anchor" href="#_2-5-1接口定义" aria-label="Permalink to &quot;2.5.1接口定义&quot;">​</a></h4><div class="language-json vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#Request:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">method: GET</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">111</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">表示的是手机号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">url:api/v</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">/smscode/:mobile</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">url:api/v</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">1.0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">/smscode/</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">111</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">?  text=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">248484</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">&amp;id=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">9</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">cd</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">faa</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">9-5653-4</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">f</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">c-b</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">653-0</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">a</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">58</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">a</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">8</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">a</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">98</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">c</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">81</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">data:no input data</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#Response</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#返回成功：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">    &quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//状态码</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">    &quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;ok&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#注册失败：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">    &quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;4001&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//状态码</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">    &quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;状态错误信息&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="_2-5-2业务流程图" tabindex="-1">2.5.2业务流程图 <a class="header-anchor" href="#_2-5-2业务流程图" aria-label="Permalink to &quot;2.5.2业务流程图&quot;">​</a></h4><p><img src="`+u+`" alt=""></p><h4 id="_2-5-3具体业务实现" tabindex="-1">2.5.3具体业务实现 <a class="header-anchor" href="#_2-5-3具体业务实现" aria-label="Permalink to &quot;2.5.3具体业务实现&quot;">​</a></h4><p>由业务流程图可知，前端会传递uuid和电话号码，首先需要获取一下验证码输入是否正确，如果正确就发送短信，并对短信内容进行缓存，成功返回ok。首先，我们先来创建短信服务，命令如下：</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> micro</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --type</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> srv</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> project/getSmscd</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>然后根据设计文档中的传入传出参数修改proto文件并编译自动生成的proto文件，修改后的proto文件如下：</p><div class="language-protobuf vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">protobuf</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">syntax</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;proto3&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">package</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> go.micro.srv.getSmscd</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">service</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> GetSmscd</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	rpc</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> Call</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">returns</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Response</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">message</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> Request</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> phone </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> text </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> uuid </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">message</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>然后编译生成对应接口，接着修改main.go文件，具体的和上面两个服务类似，不做重复介绍，重点是我们具体业务的实现。首先我们还是要先验证图片验证码输入是否正确，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//校验验证码输入是否正确</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	redisConn </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> model.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">InitRedis</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	defer</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> redisConn.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Close</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	code,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(redisConn.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Do</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;get&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,req.Uuid))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> code </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> req.Text{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>然后使用传输过来的电话号码进行短信发送，代码借鉴我们品优购的短信发送代码，内容如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//发送短信</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//初始化客户端  需要accessKey  需要开通申请</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	client, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> sdk.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewClientWithAccessKey</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;LTAI01Pc2yYrheUc&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;7diQBKg04TxpykIWli4VCVJUZbqmYX&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//获取6位数随机码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	rnd </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> rand.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">New</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(rand.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewSource</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(time.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Now</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">UnixNano</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	vcode </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Sprintf</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">%06d</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, rnd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Int31n</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">1000000</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//初始化请求对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> requests.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewCommonRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.Method </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;POST&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//设置请求方法</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.Scheme </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;https&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // https | http</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //设置请求协议</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.Domain </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;dysmsapi.aliyuncs.com&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  //域名</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.Version </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;2017-05-25&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			//版本号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.ApiName </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;SendSms&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				//api名称</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.QueryParams[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;PhoneNumbers&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> req.Phone  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//需要发送的电话号码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.QueryParams[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;SignName&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;品优购&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //签名名称   需要申请</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.QueryParams[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;TemplateCode&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;SMS_164275022&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //模板号   需要申请</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.QueryParams[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;TemplateParam&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> \`{&quot;code&quot;:\`</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">vcode</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">\`}\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //发送短信验证码</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	response, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">ProcessCommonRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(request)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//发送短信</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>发送成功之后把数据存储到redis中，并返回结果，具体代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//校验是否发送成功,成功之后存储到redis中,失败返回错误信息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">IsSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		redisConn.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Do</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;setex&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,req.Phone</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;_code&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">60</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,vcode)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_OK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_OK)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_SMSERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_SMSERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> errors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">New</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;发送短信失败&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>全部代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//校验验证码输入是否正确</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	redisConn </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> model.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">InitRedis</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	defer</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> redisConn.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Close</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	code,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(redisConn.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Do</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;get&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,req.Uuid))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> code </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> req.Text{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//发送短信</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//初始化客户端  需要accessKey  需要开通申请</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	client, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> sdk.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewClientWithAccessKey</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;default&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;LTAI01Pc2yYrheUc&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;7diQBKg04TxpykIWli4VCVJUZbqmYX&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//获取6位数随机码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	rnd </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> rand.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">New</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(rand.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewSource</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(time.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Now</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">UnixNano</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	vcode </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Sprintf</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">%06d</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, rnd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Int31n</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">1000000</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//初始化请求对象</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> requests.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewCommonRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.Method </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;POST&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//设置请求方法</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.Scheme </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;https&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // https | http</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //设置请求协议</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.Domain </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;dysmsapi.aliyuncs.com&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  //域名</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.Version </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;2017-05-25&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			//版本号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.ApiName </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;SendSms&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				//api名称</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.QueryParams[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;PhoneNumbers&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> req.Phone  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//需要发送的电话号码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.QueryParams[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;SignName&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;品优购&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //签名名称   需要申请</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.QueryParams[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;TemplateCode&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;SMS_164275022&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //模板号   需要申请</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	request.QueryParams[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;TemplateParam&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> \`{&quot;code&quot;:\`</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">vcode</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">\`}\`</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //发送短信验证码</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	response, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">ProcessCommonRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(request)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//发送短信</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//校验是否发送成功,成功之后存储到redis中,失败返回错误信息</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> response.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">IsSuccess</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		redisConn.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Do</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;setex&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,req.Phone</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;_code&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">60</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,vcode)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_OK</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_OK)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_SMSERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_SMSERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> errors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">New</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;发送短信失败&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h4 id="_2-5-4web端实现" tabindex="-1">2.5.4web端实现 <a class="header-anchor" href="#_2-5-4web端实现" aria-label="Permalink to &quot;2.5.4web端实现&quot;">​</a></h4><p>后台服务实现之后我们接着来写一下web端代码，首先需要先匹配对应路由，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">r1.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">GET</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;/smscode/:mobile&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,controller.GetSmscd)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>接着我们来实现具体的控制器函数。</p><p>还是我们的四步骤，先获取数据，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//获取数据</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	phone </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Param</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;mobile&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	text </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Query</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;text&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	uuid </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Query</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后校验数据：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//校验电话号码格式</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	reg ,_</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> regexp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Compile</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">\`^1[3,4,5,7,8]\\d{9}$\`</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	result </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> reg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">MatchString</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(phone)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">result{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_MOBILEERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_MOBILEERR)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,resp)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//校验数据不能为空</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> text </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> uuid </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,resp)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>然后远程调用，获取返回数据，具体代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//调用远程服务</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	grpcService </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">GetGrpcService</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	client </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> getSmscd.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewGetSmscdService</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;go.micro.srv.getSmscd&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,grpcService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Client</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	rsp,err</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Call</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">TODO</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(),</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">getSmscd</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		Text:text,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		Uuid:uuid,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		Phone:phone,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(err)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_SMSERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_SMSERR)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,resp)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_2-6发送注册信息服务" tabindex="-1">2.6发送注册信息服务 <a class="header-anchor" href="#_2-6发送注册信息服务" aria-label="Permalink to &quot;2.6发送注册信息服务&quot;">​</a></h3><h4 id="_2-6-1接口定义" tabindex="-1">2.6.1接口定义 <a class="header-anchor" href="#_2-6-1接口定义" aria-label="Permalink to &quot;2.6.1接口定义&quot;">​</a></h4><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#Request:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">method: POST</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">url:api</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">v1.</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">0</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">users</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#data:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">    mobile: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//手机号</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">    password: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//密码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">    sms_code: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;123&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   //短信验证码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#Response</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#返回成功：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">    &quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//状态码</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">    &quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;ok&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">#注册失败：</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">    &quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;4001&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//状态码</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">    &quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;状态错误信息&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="_2-6-2业务流程图" tabindex="-1">2.6.2业务流程图 <a class="header-anchor" href="#_2-6-2业务流程图" aria-label="Permalink to &quot;2.6.2业务流程图&quot;">​</a></h4><p><img src="`+b+`" alt=""></p><h4 id="_2-6-3具体业务实现" tabindex="-1">2.6.3具体业务实现 <a class="header-anchor" href="#_2-6-3具体业务实现" aria-label="Permalink to &quot;2.6.3具体业务实现&quot;">​</a></h4><p>创建服务，命令如下：</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> micro</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> new</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> --type</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> srv</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> project/postRet</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>接着我们修改proto文件并编译，修改后的proto文件内容如下：</p><div class="language-protobuf vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">protobuf</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">syntax</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;proto3&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">package</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> go.micro.srv.postRet</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">service</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> PostRet</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	rpc</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> Call</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">returns</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Response</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">message</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> Request</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> mobile </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> password </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> sms_code </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">message</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>具体的业务代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//从redis中获取短信验证码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	redisConn </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> model.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">InitRedis</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	code,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(redisConn.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Do</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;get&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,req.Mobile</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">+</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;_code&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//校验验证码是否正确</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> code </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> req.SmsCode{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> errors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">New</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;验证码不正确&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//把用户数据插入到mysql中</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	db,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> model.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">InitDb</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DBERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DBERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> errors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">New</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;数据库连接错误&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	var</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> user </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">model</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">User</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	user.Name </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> req.Mobile</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	user.Mobile </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> req.Mobile</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//对密码做md5加密</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	m5 </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> md5.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">New</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	m5.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Write</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">([]</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(req.Password))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	m5Pwd </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> hex.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">EncodeToString</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(m5.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Sum</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	user.Password_hash </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> m5Pwd</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> db.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Create</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">user).Error</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DBERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		rsp.Errmsg </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DBERR)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h4 id="_2-6-4session中间件使用" tabindex="-1">2.6.4session中间件使用 <a class="header-anchor" href="#_2-6-4session中间件使用" aria-label="Permalink to &quot;2.6.4session中间件使用&quot;">​</a></h4><p>首先我们来看一下gin中间件具体是什么？其实gin中间件功能很类似我们beego中的路由过滤器。不过功能更强大。我们先来看一个自定义中间件的简单示例：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> Logger</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">() </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">gin</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">HandlerFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	return</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> func</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#E36209;">c</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">gin</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		t </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> time.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Now</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// 在路由之前调用上面代码</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		c.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Next</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		//在路由之后调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		latency </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> time.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Since</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(t)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(latency)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	r </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> gin.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Default</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	r.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Use</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Logger</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">())</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	r.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">GET</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;/test&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#E36209;">c</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">gin</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">			c.Writer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Write</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">([]</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;hello world&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	})</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	r.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Run</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;:8080&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>除了自定义中间件，gin还提供了一些框架中间件，地址为：<a href="https://github.com/gin-contrib/" target="_blank" rel="noreferrer">https://github.com/gin-contrib/</a></p><p>这里我们选择使用session。首先我们需要下载session，命令如下：</p><div class="language-shell vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> go</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> get</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -u</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> -v</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> github.com/gin-contrib/sessions</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>然后我们来看一下sessions的简单使用。首先是做session的初始化，主要是做session容器的设置，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">store, _ </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> redis.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewStore</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;tcp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;localhost:6379&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, []</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">byte</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;secret&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">router.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Use</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(sessions.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Sessions</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;mysession&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">, store))</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后我们就可以在下面的路由中去使用相应的sessions操作了，具体操作如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">s </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> sessions.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Default</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(ctx)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Set</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;itcast&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	name </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Delete</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;name&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>但是大家这时候发现，在服务中我们并没有使用gin的路由，也没有对应的gin.Context,所以在服务中实现session的添加比较复杂，我们可以把session操作放在web端来处理，具体操作我们接着往下看。</p><h4 id="_2-6-5web端实现" tabindex="-1">2.6.5web端实现 <a class="header-anchor" href="#_2-6-5web端实现" aria-label="Permalink to &quot;2.6.5web端实现&quot;">​</a></h4><p>首先是做路由匹配，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">r1.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">POST</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;/users&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,controller.PostRet)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>有请求之后，接着我们去实现对应控制器方法。首先是获取数据，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//确定容器</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	resp </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> make</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">interface</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{})</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	//绑定数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	var</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> regUser </span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RegisterUser</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Bind</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">regUser)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,resp)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p>这里面需要注意，gin里面获取post上传的formdata数据使用postForm，但是如果获取json格式数据，需要去绑定对应结构体，所以这里面我们需要先创建一个和json数据对应的结构体,结构体结构如下：</p></blockquote><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;"> RegisterUser</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Mobile </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> \`json:&quot;mobile&quot;\`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	Password </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">  \`json:&quot;password&quot;\`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	SmsCode </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">string</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">    \`json:&quot;sms_code&quot;\`</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这样我们久能获取数据了，然后需要对数据进行校验，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//校验数据</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> regUser.Mobile </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> regUser.Password </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> regUser.SmsCode </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,resp)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	reg,_ </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> regexp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Compile</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">\`^1[3,4,5,7,8]\\d{9}$\`</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">reg.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">MatchString</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(regUser.Mobile){</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,resp)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>然后进行远程服务调用：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//远程调用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	grpcService </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">GetGrpcService</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	grpcClient </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> postRet.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">NewPostRetService</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;go.micro.srv.postRet&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,grpcService.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Client</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	respData,err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> grpcClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Call</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">TODO</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(),</span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">postRet</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">{Mobile:regUser.Mobile,Password:regUser.Password,SmsCode:regUser.SmsCode})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> err </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errno&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_DATAERR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		resp[</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;errmsg&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">RecodeText</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(utils.RECODE_DATAERR)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#005CC5;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,resp)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">		return</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>根据返回值，设置session，代码如下：</p><div class="language-go vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-light vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> respData.Errno </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> utils.RECODE_OK{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		s </span><span style="--shiki-light:#D73A49;--shiki-dark:#D73A49;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;"> sessions.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Default</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(ctx)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">		s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Set</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#032F62;">&quot;userName&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">,regUser.Mobile)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">        s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#6F42C1;">Save</span><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#24292E;">	}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div>`,202)]))}const _=i(o,[["render",C]]);export{R as __pageData,_ as default};
